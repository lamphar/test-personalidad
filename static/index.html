<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tests de Personalidad Cient√≠ficos</title>
  <!-- Bootstrap CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <!-- Custom Styles -->
  <style>
    body {
      background: linear-gradient(to right, #f8f9fa, #e0f7fa);
      font-family: 'Segoe UI', sans-serif;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .card {
      border: none;
      border-radius: 15px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
      max-width: 600px;
      width: 100%;
    }
    .btn-primary {
      background-color: #00695c;
      border: none;
    }
    .btn-primary:hover {
      background-color: #004d40;
    }
    .btn-success {
      background-color: #43a047;
      border: none;
    }
    .btn-success:hover {
      background-color: #2e7d32;
    }
    .progress-bar {
      transition: width 0.3s ease;
    }
    #menuCard h1, #testCard h2 {
      font-size: 1.75rem;
    }
  </style>
</head>
<body>
  <div class="container p-4">
    <!-- Menu Selection Card -->
    <div class="card p-4 text-center" id="menuCard">
      <h1 class="mb-3">üß† Explora tu Personalidad</h1>
      <p class="mb-4">Selecciona un test para comenzar tu autoexploraci√≥n basada en ciencia:</p>
      <div class="d-grid gap-3">
        <button class="btn btn-primary" data-test="estoicismo">üßò Test de Estoicismo</button>
        <button class="btn btn-primary" data-test="autoestima">üíñ Test de Autoestima</button>
        <button class="btn btn-primary" data-test="resiliencia">üõ°Ô∏è Test de Resiliencia</button>
      </div>
    </div>

    <!-- Test Execution Card -->
    <div class="card p-4 d-none" id="testCard">
      <h2 class="text-center mb-3" id="testTitle">Test</h2>
      <div class="progress mb-3">
        <div id="progressBar" class="progress-bar bg-success" role="progressbar" style="width: 0%"></div>
      </div>
      <form id="testForm">
        <div id="questionContainer" class="mb-4"></div>
        <div class="d-grid gap-2 mb-3">
          <button type="button" id="nextBtn" class="btn btn-primary">Siguiente</button>
        </div>
        <div id="finalSection" class="d-none">
          <div class="mb-3">
            <label for="email" class="form-label">Correo electr√≥nico:</label>
            <input type="email" id="email" class="form-control" required>
          </div>
          <div class="form-check mb-3">
            <input class="form-check-input" type="checkbox" id="terms" required>
            <label class="form-check-label" for="terms">
              Acepto los <a href="/terminos.html" target="_blank">t√©rminos y condiciones</a> y la <a href="/privacidad.html" target="_blank">pol√≠tica de privacidad</a>.
            </label>
          </div>
          <button type="submit" class="btn btn-success">Enviar y recibir an√°lisis</button>
        </div>
      </form>
      <div id="paymentSection" class="mt-4 d-none text-center">
        <div class="alert alert-info">
          Para apoyar este servicio cient√≠fico, te pedimos una cooperaci√≥n simb√≥lica de 0.50‚Ç¨.
        </div>
        <a href="https://buy.stripe.com/test_donation_link" class="btn btn-success mb-2">Colaborar 0.50‚Ç¨</a>
        <p class="text-muted" style="font-size: 0.85rem;">Sin suscripciones ocultas. Sin cargos recurrentes. Tu privacidad est√° garantizada.</p>
      </div>
    </div>
  </div>

  <!-- Core JavaScript -->
  <script>
    /**
     * Definici√≥n de tests y preguntas
     * Cada array corresponde a un test validado cient√≠ficamente
     */
    const TESTS = {
      estoicismo: {
        title: 'üßò Test de Estoicismo',
        questions: [
          'Suelo mantener la calma ante situaciones dif√≠ciles.',
          'Acepto aquello que no puedo controlar sin resistirme.',
          'Reflexiono antes de reaccionar emocionalmente.',
          'Me esfuerzo por ser virtuoso m√°s que exitoso.',
          'No me altero f√°cilmente por lo que otros opinan de m√≠.',
          'Evito el placer excesivo porque s√© que es ef√≠mero.',
          'Afronto el sufrimiento con dignidad.',
          'Soy disciplinado con mis h√°bitos diarios.',
          'Pongo la raz√≥n por encima del impulso.',
          'Encuentro sentido en actuar correctamente, incluso si nadie lo nota.',
          'Me preparo mentalmente para adversidades.',
          'Trato de conocerme a m√≠ mismo con honestidad.',
          'Encuentro libertad en aceptar mi destino.',
          'Reconozco mis errores sin juzgarme duramente.',
          'No envidio los logros materiales de los dem√°s.',
          'Agradezco lo que tengo, aunque sea poco.',
          'S√© distinguir entre deseo y necesidad.',
          'Me esfuerzo por mantenerme ecu√°nime.',
          'Uso las dificultades como oportunidades para crecer.',
          'Valoro m√°s la paz interior que el reconocimiento externo.'
        ],
        evaluate: score => {
          if (score <= 50) return 'Bajo desarrollo estoico: reflexiona sobre tus reacciones y aceptaci√≥n del mundo.';
          if (score <= 70) return 'Desarrollo moderado estoico: en camino hacia un mayor equilibrio interior.';
          return 'Alto alineamiento estoico: muestras autodominio, raz√≥n y aceptaci√≥n.';
        }
      },
      autoestima: {
        title: 'üíñ Test de Autoestima (Rosenberg)',
        questions: [
          'Siento que soy una persona digna de aprecio, al menos en igual medida que los dem√°s.',
          'Siento que tengo cualidades positivas.',
          'Soy capaz de hacer las cosas tan bien como la mayor√≠a de las personas.',
          'Tengo una actitud positiva hacia m√≠ mismo.',
          'Estoy satisfecho conmigo mismo.',
          'A veces siento que no soy bueno para nada.',
          'Me gustar√≠a tener m√°s respeto por m√≠ mismo.',
          'Hay veces en que realmente me siento in√∫til.',
          'A veces pienso que no soy una buena persona.',
          'En general, me considero una persona valiosa.'
        ],
        evaluate: score => {
          if (score <= 25) return 'Autoestima baja: puede ser √∫til trabajar en tu autovaloraci√≥n.';
          if (score <= 35) return 'Autoestima moderada: en proceso de construir una autoimagen saludable.';
          return 'Autoestima alta: percepci√≥n saludable de ti mismo.';
        }
      },
      resiliencia: {
        title: 'üõ°Ô∏è Test de Resiliencia (CD-RISC)',
        questions: [
          'Puedo adaptarme a los cambios con rapidez.',
          'Veo el lado positivo incluso en situaciones dif√≠ciles.',
          'Mantengo la calma bajo presi√≥n.',
          'Puedo tomar decisiones efectivas en momentos dif√≠ciles.',
          'Tengo confianza en mi capacidad para enfrentar problemas.',
          'Me recupero r√°pidamente de decepciones.',
          'Encuentro maneras de crecer a partir de las dificultades.',
          'Mantengo una actitud positiva incluso cuando las cosas van mal.',
          'Soy capaz de seguir adelante despu√©s de fracasos.',
          'S√© cu√°ndo pedir ayuda y hacerlo me fortalece.'
        ],
        evaluate: score => {
          if (score <= 25) return 'Resiliencia baja: considera estrategias de afrontamiento para fortalecer la resiliencia.';
          if (score <= 35) return 'Resiliencia moderada: apoyando tus habilidades de adaptaci√≥n.';
          return 'Resiliencia alta: adaptabilidad y fortaleza ante la adversidad.';
        }
      }
    };

    // Estado de la prueba
    let currentTest = null;
    let currentIndex = 0;
    let answers = [];

    // Referencias al DOM
    const menuCard = document.getElementById('menuCard');
    const testCard = document.getElementById('testCard');
    const testTitle = document.getElementById('testTitle');
    const questionContainer = document.getElementById('questionContainer');
    const nextBtn = document.getElementById('nextBtn');
    const progressBar = document.getElementById('progressBar');
    const finalSection = document.getElementById('finalSection');
    const paymentSection = document.getElementById('paymentSection');

    // Inicializaci√≥n de listeners
    document.querySelectorAll('#menuCard button[data-test]').forEach(btn => {
      btn.addEventListener('click', () => initTest(btn.getAttribute('data-test')));
    });

    nextBtn.addEventListener('click', nextQuestion);
    document.getElementById('testForm').addEventListener('submit', sendResults);

    /**
     * Inicia el test seleccionado
     */
    function initTest(testKey) {
      currentTest = TESTS[testKey];
      currentIndex = 0;
      answers = [];
      testTitle.textContent = currentTest.title;
      menuCard.classList.add('d-none');
      testCard.classList.remove('d-none');
      showQuestion();
    }

    /**
     * Muestra la pregunta actual y actualiza la barra de progreso
     */
    function showQuestion() {
      questionContainer.innerHTML = `
        <label class="form-label">${currentTest.questions[currentIndex]}</label>
        <select class="form-select" id="answer">
          <option value="1">Muy en desacuerdo</option>
          <option value="2">En desacuerdo</option>
          <option value="3">Ni de acuerdo ni en desacuerdo</option>
          <option value="4">De acuerdo</option>
          <option value="5">Muy de acuerdo</option>
        </select>
      `;
      progressBar.style.width = `${((currentIndex) / currentTest.questions.length) * 100}%`;
    }

    /**
     * Procesa la respuesta y avanza o muestra la secci√≥n final
     */
    function nextQuestion() {
      const val = parseInt(document.getElementById('answer').value);
      answers.push(val);
      currentIndex++;
      if (currentIndex < currentTest.questions.length) {
        showQuestion();
      } else {
        completeTest();
      }
    }

    /**
     * Finaliza el test mostrando el formulario de correo y pago
     */
    function completeTest() {
      nextBtn.classList.add('d-none');
      questionContainer.classList.add('d-none');
      finalSection.classList.remove('d-none');
      progressBar.style.width = '100%';
    }

    /**
     * Env√≠a resultados al backend y muestra opci√≥n de pago
     */
    async function sendResults(e) {
      e.preventDefault();
      const email = document.getElementById('email').value;
      const total = answers.reduce((sum, v) => sum + v, 0);
      const feedback = currentTest.evaluate(total);

      try {
        await fetch('https://test-personalidad.onrender.com/send-email', {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({email,resultado:feedback})
        });
        paymentSection.classList.remove('d-none');
      } catch (err) {
        console.error('Error enviando correo:', err);
        alert('Hubo un error enviando los resultados. Por favor, int√©ntalo de nuevo.');
      }
    }
  </script>
</body>
</html>
