<script>
  const p = new URLSearchParams(location.search);
  const test = p.get('test') || 'Test';
  const scores = (p.get('score') || '0').split(',').map(Number);
  const labels = ['Apertura', 'Responsabilidad', 'Extraversión', 'Amabilidad', 'Neuroticismo'];

  const subtitle = document.getElementById('subtitle');
  subtitle.innerText = test === 'Big Five' ? 'Test de Personalidad – Big Five' : `Test de ${test}`;

  const ctx = document.getElementById('resultChart').getContext('2d');
  let chart;
  if (test === 'Big Five') {
    chart = new Chart(ctx, {
      type: 'radar',
      data: {
        labels: labels,
        datasets: [{
          label: 'Puntuación',
          data: scores,
          backgroundColor: 'rgba(46,139,192,0.2)',
          borderColor: '#2E8BC0',
          pointBackgroundColor: '#2E8BC0'
        }]
      },
      options: { scales: { r: { min: 0, max: 100 } } }
    });
  } else {
    const score = scores[0] || 0;
    chart = new Chart(ctx, {
      type: 'doughnut',
      data: {
        labels: ['Obtenido', 'Restante'],
        datasets: [{ data: [score, 100 - score], backgroundColor: ['#2E8BC0', '#E2E8F0'], borderWidth: 0 }]
      },
      options: { cutout: '60%', plugins: { legend: { display: false }, tooltip: { enabled: false } } }
    });
  }

  const A = document.getElementById('analysisText');
  function add(title, txt) {
    A.innerHTML += `<h4>${title}</h4><p>${txt}</p>`;
  }

  if (test === 'Big Five') {
    const descs = [
      [
        'Tienes una mente curiosa, creativa y abierta a nuevas experiencias.',
        'Muestras una apertura moderada con equilibrio entre curiosidad e interés práctico.',
        'Prefieres lo familiar y estructuras conocidas más que la novedad.'
      ],
      [
        'Eres muy organizado, confiable y perseverante.',
        'Tu nivel de responsabilidad es equilibrado, sueles cumplir pero también improvisar.',
        'Tienes dificultades para estructurar tareas o mantener la disciplina.'
      ],
      [
        'Eres sociable, energético y disfrutas interactuar con los demás.',
        'Tu extraversión es moderada; te adaptas bien a lo social sin buscarlo intensamente.',
        'Prefieres ambientes tranquilos y la introspección a lo social.'
      ],
      [
        'Eres empático, amable y considerado con los demás.',
        'Tienes una amabilidad equilibrada; ayudas a otros pero mantienes límites.',
        'Tiendes a ser más crítico, directo o desconfiado en relaciones interpersonales.'
      ],
      [
        'Sueles experimentar emociones intensas y cambios de ánimo frecuentes.',
        'Tienes un equilibrio emocional razonable, con ocasionales momentos de tensión.',
        'Disfrutas de una gran estabilidad emocional y tolerancia al estrés.'
      ]
    ];
    scores.forEach((val, i) => {
      const nivel = val >= 70 ? 0 : val >= 40 ? 1 : 2;
      add(labels[i], descs[i][nivel]);
    });
  }

  function descargarPDF() {
    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF();
    pdf.setFontSize(18);
    pdf.text('Informe MindPath', 20, 20);
    pdf.setFontSize(12);
    pdf.text(subtitle.innerText, 20, 30);

    // Exportar gráfico
    const canvas = document.getElementById('resultChart');
    const imgData = canvas.toDataURL('image/png');
    pdf.addImage(imgData, 'PNG', 50, 40, 110, 60);

    let y = 110;
    document.querySelectorAll('.analysis h4').forEach((h4, i) => {
      pdf.setFontSize(14);
      pdf.text(h4.innerText, 20, y);
      y += 8;
      pdf.setFontSize(11);
      const txt = document.querySelectorAll('.analysis p')[i].innerText;
      const lines = pdf.splitTextToSize(txt, 170);
      pdf.text(lines, 20, y);
      y += lines.length * 6 + 4;
    });
    pdf.save(`MindPath_${test}_Informe.pdf`);
  }
</script>
